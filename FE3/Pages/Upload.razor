@page "/upload"
@using FE3.Components
@using FE3.VoxelRenderer
@inject ModelsService Models

<MudContainer MaxWidth="MaxWidth.False" Class="pa-6">

    <MudText Typo="Typo.h4" Class="mb-4">Upload model</MudText>

    <MudGrid Spacing="3">

        <!-- LEFT: Details + Actions -->
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Spacing="3">

                    <MudText Typo="Typo.h6">Model details</MudText>

                    <MudTextField Label="Name" Variant="Variant.Outlined" @bind-Value="_name" Disabled="_busy" />

                    <MudDivider />

                    <MudStack Spacing="1">
                        <MudText Typo="Typo.subtitle2">Model file (.fotr)</MudText>

                        <InputFile OnChange="OnFileChanged" accept=".fotr" disabled="@_busy" />

                        @if (_fileName != null)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@_fileName</MudText>
                        }
                    </MudStack>

                    <MudDivider />

                    <MudStack Row Spacing="2">
                        <MudButton Variant="Variant.Outlined" Disabled="_model is null || _busy" OnClick="Capture">
                            Capture thumbnail
                        </MudButton>

                        <MudButton Variant="Variant.Filled" Color="Color.Success" Disabled="!CanUpload || _busy" OnClick="UploadAsync">
                            Upload
                        </MudButton>
                    </MudStack>

                    @if (_thumbUrl != null)
                    {
                        <MudPaper Class="pa-2 mt-2" Outlined="true">
                            <MudText Typo="Typo.caption" Class="mb-1">Thumbnail preview</MudText>

                            <img src="@_thumbUrl"
                                 style="width:100%;height:180px;object-fit:contain;border-radius:6px;" />
                        </MudPaper>
                    }

                    @if (_msg != null)
                    {
                        <MudAlert Severity="_severity" Dense="true">@_msg</MudAlert>
                    }

                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- RIGHT: Preview -->
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-2" Elevation="1">

                <MudText Typo="Typo.h6" Class="mb-2">Preview</MudText>

                <VoxelModelViewer @ref="_viewer" @key="_model"
                                  Title="Preview"
                                  CanvasWidth="1000" CanvasHeight="600"
                                  ShowControls="true" Model="_model"
                                  OnThumbnailDataUrl="OnThumbUrl"
                                  OnThumbnailPngBytes="OnThumbBytes" />

            </MudPaper>
        </MudItem>

    </MudGrid>
</MudContainer>


@code
{
    VoxelModelViewer _viewer = null!;

    string _name = "";
    string? _fileName;

    byte[]? _modelBytes;
    UnmanagedVoxelModel? _model;

    string? _thumbUrl;
    byte[]? _thumbPng;

    bool _busy;
    string? _msg;
    Severity _severity = Severity.Info;

    bool CanUpload =>
        !string.IsNullOrWhiteSpace(_name) &&
        _modelBytes?.Length > 0 &&
        _thumbPng?.Length > 0;

    async Task OnFileChanged(InputFileChangeEventArgs e)
    {
        _msg = null;
        _thumbUrl = null;
        _thumbPng = null;

        _model?.Dispose();
        _model = null;

        var file = e.File;
        if (file == null) return;

        _fileName = file.Name;

        await using var s = file.OpenReadStream(50 * 1024 * 1024);
        using var ms = new MemoryStream();
        await s.CopyToAsync(ms);

        _modelBytes = ms.ToArray();
        try
        {
            _model?.Dispose();
            _model = UnmanagedVoxelModel.Deserialize(_modelBytes!);
            _msg = "Preview ready. Click Capture.";
            _severity = Severity.Info;
        }
        catch (Exception ex)
        {
            _severity = Severity.Error;
            _msg = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }


    async Task Capture()
    {
        try
        {
            await _viewer.CaptureAsync();
            _msg = "Thumbnail captured.";
            _severity = Severity.Info;
        }
        catch (Exception ex)
        {
            _severity = Severity.Error;
            _msg = ex.Message;
        }
    }

    async Task UploadAsync()
    {
        if (!CanUpload) return;

        _busy = true;
        _msg = null;

        try
        {
            await Models.UploadAsync(
                _modelBytes!,
                _thumbPng!,
                _name);

            _severity = Severity.Success;
            _msg = "Upload successful.";
        }
        catch (Exception ex)
        {
            _severity = Severity.Error;
            _msg = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    Task OnThumbUrl(string url)
    {
        _thumbUrl = url;
        return Task.CompletedTask;
    }

    Task OnThumbBytes(byte[] bytes)
    {
        _thumbPng = bytes;
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _model?.Dispose();
    }
}
