@* Pages/Index.razor (ONLY change: replace the inline MudCard with a component call) *@
@page "/"
@using FE3.Api.Types
@using MudBlazor
@using FE3.Components
@inject Uri ApiBaseUri
@inject ModelsService ModelsService

<MudContainer MaxWidth="MaxWidth.False" Class="pa-6">

    <MudStack Spacing="3">

        <!-- Header -->
        <MudPaper Outlined="true" Class="pa-4">
            <MudText Typo="Typo.h4">Voxel Gallery</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Browse public voxel models
            </MudText>
        </MudPaper>

        <!-- Controls -->
        <MudPaper Outlined="true" Class="pa-4">
            <MudGrid Spacing="2" AlignItems="AlignItems.Center">

                <MudItem xs="12" md="4">
                    <MudTextField Label="Search"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  @bind-Value="Search"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Disabled="_loading" />
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudSelect T="SortMode"
                               Label="Sort"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               @bind-Value="Sort"
                               Disabled="_loading">
                        <MudSelectItem Value="SortMode.Newest">Newest</MudSelectItem>
                        <MudSelectItem Value="SortMode.Oldest">Oldest</MudSelectItem>
                        <MudSelectItem Value="SortMode.NameAsc">Name (A–Z)</MudSelectItem>
                        <MudSelectItem Value="SortMode.NameDesc">Name (Z–A)</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudSelect T="int"
                               Label="Items per page"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               @bind-Value="PageSize"
                               Disabled="_loading">
                        <MudSelectItem Value="12">12</MudSelectItem>
                        <MudSelectItem Value="24">24</MudSelectItem>
                        <MudSelectItem Value="48">48</MudSelectItem>
                    </MudSelect>
                </MudItem>

            </MudGrid>
        </MudPaper>

        @if (_loading)
        {
            <MudPaper Outlined="true" Class="pa-4">
                <MudProgressLinear Indeterminate />
            </MudPaper>
        }
        else if (_filtered.Count == 0)
        {
            <MudPaper Outlined="true" Class="pa-4">
                <MudText Color="Color.Secondary">No models found.</MudText>
            </MudPaper>
        }
        else
        {
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Showing @PageItems.Count() of @_filtered.Count models
            </MudText>

            <!-- Grid -->
            <MudGrid Spacing="3">
                @foreach (var model in PageItems)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3" xl="2" @key="model.Id">
                        <VoxelGalleryItem Model="model" ApiBaseUri="ApiBaseUri" />
                    </MudItem>
                }
            </MudGrid>

            <!-- Pager -->
            <MudPaper Outlined="true" Class="pa-4 mt-4">
                <MudStack Row
                          Spacing="2"
                          AlignItems="AlignItems.Center"
                          JustifyContent="JustifyContent.SpaceBetween">

                    <MudText Typo="Typo.body2">
                        Page @(_pageIndex + 1) of @TotalPages
                    </MudText>

                    <MudStack Row Spacing="1">
                        <MudButton Variant="Variant.Outlined"
                                   Disabled="_pageIndex == 0"
                                   OnClick="@(() => PrevPage())">
                            Prev
                        </MudButton>

                        <MudButton Variant="Variant.Outlined"
                                   Disabled="_pageIndex >= TotalPages - 1"
                                   OnClick="@(() => NextPage())">
                            Next
                        </MudButton>
                    </MudStack>

                </MudStack>
            </MudPaper>
        }

    </MudStack>

</MudContainer>

@code {
    private bool _loading = true;
    private IReadOnlyList<ModelItem> _models = Array.Empty<ModelItem>();
    private List<ModelItem> _filtered = new();

    private int _pageIndex = 0;
    private int _pageSize = 24;
    private string _search = "";
    private SortMode _sort = SortMode.Newest;

    protected override async Task OnInitializedAsync()
    {
        _models = await ModelsService.GetPublicModelsAsync();
        _loading = false;
        Recompute();
    }

    private void Recompute()
    {
        IEnumerable<ModelItem> q = _models;

        if (!string.IsNullOrWhiteSpace(_search))
        {
            q = q.Where(m =>
                !string.IsNullOrEmpty(m.Name) &&
                m.Name.Contains(_search, StringComparison.OrdinalIgnoreCase));
        }

        q = _sort switch
        {
            SortMode.Newest => q.OrderByDescending(m => m.CreatedAtUtc),
            SortMode.Oldest => q.OrderBy(m => m.CreatedAtUtc),
            SortMode.NameAsc => q.OrderBy(m => m.Name),
            SortMode.NameDesc => q.OrderByDescending(m => m.Name),
            _ => q
        };

        _filtered = q.ToList();
        _pageIndex = 0;
    }

    private IEnumerable<ModelItem> PageItems =>
        _filtered.Skip(_pageIndex * _pageSize).Take(_pageSize);

    private int TotalPages =>
        Math.Max(1, (int)Math.Ceiling(_filtered.Count / (double)_pageSize));

    private void PrevPage()
    {
        if (_pageIndex > 0)
            _pageIndex--;
    }

    private void NextPage()
    {
        if (_pageIndex < TotalPages - 1)
            _pageIndex++;
    }

    private string Search
    {
        get => _search;
        set
        {
            if (_search == value) return;
            _search = value;
            Recompute();
        }
    }

    private SortMode Sort
    {
        get => _sort;
        set
        {
            if (_sort == value) return;
            _sort = value;
            Recompute();
        }
    }

    private int PageSize
    {
        get => _pageSize;
        set
        {
            if (_pageSize == value) return;
            _pageSize = value;
            _pageIndex = 0;
        }
    }

    private enum SortMode
    {
        Newest,
        Oldest,
        NameAsc,
        NameDesc
    }
}
