@page "/"
@using System.Linq
@using System.Numerics
@using Microsoft.JSInterop
@using MudBlazor
@using Ab4d.SharpEngine.Cameras
@using Ab4d.SharpEngine.Common
@using Ab4d.SharpEngine.Materials
@using Ab4d.SharpEngine.SceneNodes
@using Ab4d.SharpEngine.Lights
@using Ab4d.SharpEngine.Meshes
@using FE3.VoxelRenderer
@using Colors = Ab4d.SharpEngine.Common.Colors
@implements IDisposable
@inject IJSRuntime JS

<MudContainer MaxWidth="MaxWidth.False" Class="pa-6">
    <MudStack Spacing="3">
        <MudText Typo="Typo.h4">Voxel Gallery</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            Grid uses real screenshots captured from the single live WebGL preview.
        </MudText>

        <MudGrid Spacing="3">
            <!-- LEFT: grid thumbnails (images captured from live preview) -->
            <MudItem xs="12" md="7" lg="8">
                <MudGrid Spacing="3">
                    @foreach (var item in _items)
                    {
                        <MudItem xs="12" sm="6" md="6" lg="4" @key="item.Id">
                            <MudPaper Elevation="0"
                                      Outlined="true"
                                      Class="@GetTileClass(item)"
                                      OnClick="@(() => Select(item.Id))">

                                <div class="tile">
                                    <div class="tile-preview">
                                        @if (_thumbnails.TryGetValue(item.Id, out var img))
                                        {
                                            <img src="@img" class="thumb-img" />
                                        }
                                        else
                                        {
                                            <div class="thumb-loading">
                                                <MudProgressCircular Indeterminate Size="Size.Small" />
                                            </div>
                                        }
                                    </div>

                                    <div class="tile-meta">
                                        <MudText Typo="Typo.subtitle1" Class="tile-title">@item.Title</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">by @item.Author</MudText>

                                        @if (_selectedId == item.Id)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled" Class="mt-2">
                                                Selected
                                            </MudChip>
                                        }
                                        else
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined" Class="mt-2">
                                                Click to select
                                            </MudChip>
                                        }
                                    </div>
                                </div>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            </MudItem>

            <!-- RIGHT: single live WebGL preview -->
            <MudItem xs="12" md="5" lg="4">
                <MudPaper Elevation="0" Outlined="true" Class="live-card">
                    <MudStack Spacing="2" Class="pa-4">
                        <MudText Typo="Typo.h6">Live preview</MudText>

                        <div class="live-preview-wrap">
                            <SharpEngineSceneView @ref="_liveView"
                                                  CanvasId="live_preview_canvas"
                                                  CanvasWidth="420"
                                                  CanvasHeight="320"
                                                  style="width: 100%; height: 320px;">
                            </SharpEngineSceneView>
                        </div>

                        <MudDivider />

                        <MudStack Spacing="1">
                            <MudText Typo="Typo.subtitle1" Class="tile-title">@SelectedItem?.Title</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">by @SelectedItem?.Author</MudText>
                        </MudStack>

                        <MudStack Row="true" Spacing="1">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@StartSpin">Spin</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@StopSpin">Stop</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="@RandomizeColor">Color</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="@CaptureSelectedThumbAsync">Capture</MudButton>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudStack>
</MudContainer>

<style>
    .tile {
        display: flex;
        gap: 14px;
        align-items: center;
        padding: 14px;
        border-radius: 16px;
        cursor: pointer;
        user-select: none;
        transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
    }
    .tile:hover { transform: translateY(-1px); }

    .tile-preview {
        flex: 0 0 auto;
        width: 148px;
        height: 148px;
        display: grid;
        place-items: center;
        border-radius: 14px;
        background: rgba(255,255,255,0.65);
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.08);
    }

    .thumb-loading {
        width: 100%;
        height: 100%;
        display: grid;
        place-items: center;
        background: linear-gradient(180deg, rgba(255,255,255,0.90), rgba(255,255,255,0.35));
    }

    .thumb-img {
        width: 140px;
        height: 140px;
        border-radius: 12px;
        object-fit: contain;
        display: block;
    }

    .tile-meta { min-width: 0; flex: 1 1 auto; }

    .tile-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    .tile-base {
        border-radius: 18px;
        background: rgba(255,255,255,0.55);
        backdrop-filter: blur(6px);
    }

    .tile-selected {
        border-color: rgba(25, 118, 210, 0.65) !important;
        box-shadow: 0 8px 30px rgba(25, 118, 210, 0.18);
    }

    .live-card {
        border-radius: 18px;
        background: rgba(255,255,255,0.55);
        backdrop-filter: blur(6px);
    }

    .live-preview-wrap {
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.08);
    }
</style>

@code {
    private sealed class GalleryItem
    {
        public required string Id { get; init; }
        public required string Title { get; init; }
        public required string Author { get; init; }
    }

    private readonly List<GalleryItem> _items = new()
    {
        new() { Id = "a", Title = "Single Cube",        Author = "Mock Author 1" },
        new() { Id = "b", Title = "Voxel Test Asset",   Author = "Mock Author 2" },
        new() { Id = "c", Title = "Prototype Model",    Author = "Mock Author 3" },
        new() { Id = "d", Title = "Blockout Preview",   Author = "Mock Author 4" },
        new() { Id = "e", Title = "Orange Sample",      Author = "Mock Author 5" },
        new() { Id = "f", Title = "Tiny Voxel Cube",    Author = "Mock Author 6" },
    };

    private string _selectedId = "a";
    private GalleryItem? SelectedItem => _items.FirstOrDefault(x => x.Id == _selectedId);

    private readonly Dictionary<string, string> _thumbnails = new();
    private bool _captureJsInjected;

    private SharpEngineSceneView _liveView = null!;
    private TargetPositionCamera? _camera;
    private StandardMaterial? _mat;
    private MeshModelNode? _node;

    private bool _liveInitialized;
    private string? _lastBuiltId;

    protected override void OnAfterRender(bool firstRender)
    {
        if (!_liveInitialized && _liveView?.SceneView != null)
        {
            InitializeLiveScene();
            BuildSelectedModelAndCaptureFireAndForget();
            _liveInitialized = true;
        }
    }

    private string GetTileClass(GalleryItem item)
        => _selectedId == item.Id ? "tile-base tile-selected" : "tile-base";

    private void Select(string id)
    {
        if (_selectedId == id)
            return;

        _selectedId = id;

        if (_liveInitialized)
            BuildSelectedModelAndCaptureFireAndForget();
    }

    private void InitializeLiveScene()
    {
        var scene = _liveView.Scene;
        var sceneView = _liveView.SceneView;

        sceneView.BackgroundColor = Colors.LightSkyBlue;

        scene.SetAmbientLight(0.25f);
        scene.Lights.Add(new DirectionalLight(new Vector3(-1, -0.6f, -0.2f)));

        _camera = new TargetPositionCamera
        {
            Heading = 35,
            Attitude = -25,
            Distance = 5,
            TargetPosition = new Vector3(0.5f, 0.5f, 0.5f),
            ShowCameraLight = ShowCameraLightType.Never
        };

        sceneView.Camera = _camera;
    }

    private void BuildSelectedModelAndCaptureFireAndForget()
    {
        if (_lastBuiltId == _selectedId)
            return;

        _lastBuiltId = _selectedId;

        var scene = _liveView.Scene;

        if (_node != null)
        {
            scene.RootNode.Remove(_node);
            _node.Dispose();
            _node = null;
        }

        // Mock model: single voxel cube for all items
        var model = new VoxelModel(depth: 6);
        model.SetVoxel(0, 0, 0, 1);

        var mesh = model.BuildMesh();

        var hue = (_selectedId[0] * 37) % 360;
        var color = Color3.FromHsl(hue);

        _mat = new StandardMaterial(color);
        _node = new MeshModelNode(mesh, _mat, name: $"Voxel_{_selectedId}");
        scene.RootNode.Add(_node);

        _camera!.TargetPosition = new Vector3(0.5f, 0.5f, 0.5f);
        _camera.Distance = 5;

        _ = CaptureThumbnailAsync(_selectedId);
    }

    private async Task EnsureCaptureJsAsync()
    {
        if (_captureJsInjected)
            return;

        // Single-file JS injection (no extra files).
        // Use a verbatim string (@"...") to avoid Razor choking on raw string literals.
        var js = @"
window.__captureCanvasToPng = function (canvasId) {
    const c = document.getElementById(canvasId);
    if (!c) return null;
    try {
        return c.toDataURL('image/png');
    } catch (e) {
        console.error('capture failed', e);
        return null;
    }
};
";
        await JS.InvokeVoidAsync("eval", js);

        _captureJsInjected = true;
    }

    private async Task CaptureThumbnailAsync(string itemId)
    {
        if (!_liveInitialized)
            return;

        await EnsureCaptureJsAsync();

        // Let at least one frame render after scene changes
        await Task.Delay(80);

        var dataUrl = await JS.InvokeAsync<string?>("__captureCanvasToPng", "live_preview_canvas");

        if (!string.IsNullOrWhiteSpace(dataUrl))
        {
            _thumbnails[itemId] = dataUrl!;
            await InvokeAsync(StateHasChanged);
        }
    }

    private Task CaptureSelectedThumbAsync() => CaptureThumbnailAsync(_selectedId);

    private void StartSpin()
    {
        if (_camera == null) return;
        _camera.StartRotation(headingChangeInSecond: 35);
    }

    private void StopSpin()
    {
        if (_camera == null) return;
        _camera.StopRotation();
    }

    private void RandomizeColor()
    {
        if (_mat == null) return;
        _mat.DiffuseColor = Color3.FromHsl(Random.Shared.NextDouble() * 360);

        _ = CaptureThumbnailAsync(_selectedId);
    }

    public void Dispose()
    {
        _liveView?.Dispose();
    }
}
