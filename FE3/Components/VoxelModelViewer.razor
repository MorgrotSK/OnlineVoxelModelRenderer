@using System.Numerics
@using Ab4d.SharpEngine.Cameras
@using Ab4d.SharpEngine.Common
@using Ab4d.SharpEngine.Core
@using Ab4d.SharpEngine.Lights
@using Ab4d.SharpEngine.Utilities
@using FE3.VoxelRenderer
@using Colors = Ab4d.SharpEngine.Common.Colors
@implements IDisposable
@inject IJSRuntime Js

<MudPaper Elevation="0" Outlined="true" Class="@Class" Style="@Style">
    <MudStack Spacing="2" Class="pa-4">

        @if (!string.IsNullOrWhiteSpace(Title))
        {
            <MudText Typo="Typo.h6">@Title</MudText>
        }

        <div style="border-radius:14px; overflow:hidden; border:1px solid rgba(0,0,0,0.08)">
            <SharpEngineSceneView @ref="_view" CanvasWidth="@CanvasWidth" CanvasHeight="@CanvasHeight" style="@($"width:100%; height:{CanvasHeight}px;")" />
        </div>

        @if (ShowControls)
        {
            <MudStack Spacing="1">
                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption">Distance</MudText>
                        <MudSlider T="float" Min="0.8f" Max="100f" Step="0.1f"
                                   Value="@_distance"
                                   ValueChanged="OnDistanceChanged"
                                   Disabled="@(!_ready)" />
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption">Heading</MudText>
                        <MudSlider T="float" Min="-180f" Max="180f" Step="1f"
                                   Value="@_heading"
                                   ValueChanged="OnHeadingChanged"
                                   Disabled="@(!_ready)" />
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption">Attitude</MudText>
                        <MudSlider T="float" Min="-89f" Max="89f" Step="1f"
                                   Value="@_attitude"
                                   ValueChanged="OnAttitudeChanged"
                                   Disabled="@(!_ready)" />
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption">Spin speed</MudText>
                        <MudSlider T="float" Min="0f" Max="180f" Step="1f"
                                   Value="@_spinSpeed"
                                   ValueChanged="OnSpinSpeedChanged"
                                   Disabled="@(!_ready)" />
                    </MudItem>
                </MudGrid>
            </MudStack>
        }

        @if (_error != null)
        {
            <MudAlert Severity="Severity.Error">@_error</MudAlert>
        }

    </MudStack>
</MudPaper>

@code
{
    [Parameter] public string? Title { get; set; }
    [Parameter] public bool ShowControls { get; set; } = true;

    [Parameter] public int CanvasWidth { get; set; } = 900;
    [Parameter] public int CanvasHeight { get; set; } = 520;

    [Parameter] public string Class { get; set; } = "";
    [Parameter] public string Style { get; set; } = "";

    [Parameter] public UnmanagedVoxelModel? Model { get; set; }

    [Parameter] public float SpinSpeed { get; set; } = 35;

    [Parameter] public EventCallback OnModelLoaded { get; set; }
    [Parameter] public EventCallback<string> OnThumbnailDataUrl { get; set; }
    [Parameter] public EventCallback<byte[]> OnThumbnailPngBytes { get; set; }

    SharpEngineSceneView _view = null!;
    TargetPositionCamera? _camera;
    IJSObjectReference? _jsModule;
    GpuImage? _diffuseGpuImage;
    bool _ready;
    string? _error;

    float _heading;
    float _attitude;
    float _distance;
    float _spinSpeed;

    const float DefaultHeading = 35;
    const float DefaultAttitude = -25;
    const float DefaultDistance = 5;
    static readonly Vector3 DefaultTarget = new(0.5f);

    protected override void OnAfterRender(bool first)
    {
        if (!first) return;

        InitScene();

        _heading = DefaultHeading;
        _attitude = DefaultAttitude;
        _distance = DefaultDistance;
        _spinSpeed = SpinSpeed;

        _ready = false;
        _view.SceneViewInitialized += OnSceneViewInitialized;
    }

    async void OnSceneViewInitialized(object? sender, EventArgs e)
    {
        try
        {
            _diffuseGpuImage = await TextureLoader.CreateTextureAsync("Atlas.png", _view.Scene);

            if (Model != null)
                AddVoxeldMesh(Model.Value);

            _ready = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            StateHasChanged();
        }
    }

    protected override void OnParametersSet()
    {
        if (_ready)
            _ = LoadAsync();

        if (!_ready)
            _spinSpeed = SpinSpeed;
    }

    async Task LoadAsync()
    {
        ClearNode();
        _error = null;

        try
        {
            if (Model == null)
                return;

            AddVoxeldMesh(Model.Value);

            if (OnModelLoaded.HasDelegate)
                await OnModelLoaded.InvokeAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }

        StateHasChanged();
    }

    void AddVoxeldMesh(UnmanagedVoxelModel model)
    {
        var greedy = new GreedyVoxelModel(ref model);
        _view.Scene.RootNode.Add(greedy.BuildMesh(_diffuseGpuImage));
        _camera!.Distance = DefaultDistance;
        _distance = _camera.Distance;
    }

    void InitScene()
    {
        var scene = _view.Scene;
        var view = _view.SceneView;

        view.BackgroundColor = Colors.LightSkyBlue;
        scene.SetAmbientLight(0.25f);
        scene.Lights.Add(new DirectionalLight(new Vector3(-1, -0.6f, -0.2f)));

        _camera = new TargetPositionCamera
        {
            Heading = DefaultHeading,
            Attitude = DefaultAttitude,
            Distance = DefaultDistance,
            TargetPosition = DefaultTarget,
            ShowCameraLight = ShowCameraLightType.Never
        };

        view.Camera = _camera;
    }

    void ClearNode()
    {
        _view.Scene.RootNode.DisposeAllChildren(true, true, true, true);
    }
    

    void OnDistanceChanged(float v) { _distance = v; if (_camera != null) _camera.Distance = v; }
    void OnHeadingChanged(float v)  { _heading = v; if (_camera != null) _camera.Heading = v; }
    void OnAttitudeChanged(float v) { _attitude = v; if (_camera != null) _camera.Attitude = v; }
    void OnSpinSpeedChanged(float v) => _spinSpeed = v;

    public async Task CaptureAsync()
    {
        _jsModule ??= await Js.InvokeAsync<IJSObjectReference>("import", "./js/CanvasTools.js");
        var url = await _jsModule.InvokeAsync<string?>("captureCanvasToPng", "sharpEngineCanvas_2");

        if (OnThumbnailDataUrl.HasDelegate)
            await OnThumbnailDataUrl.InvokeAsync(url);

        if (OnThumbnailPngBytes.HasDelegate && url != null)
        {
            var base64 = url[(url.IndexOf(',') + 1)..];
            await OnThumbnailPngBytes.InvokeAsync(Convert.FromBase64String(base64));
        }
    }

    public void Dispose()
    {
        ClearNode();
        _view.Scene.Dispose();
        _view?.Dispose();
        _jsModule?.DisposeAsync();
    }
}
