@using Ab4d.SharpEngine
@using Ab4d.SharpEngine.WebGL
@implements IDisposable
@implements IAsyncDisposable
@inject IJSRuntime JS

<!-- 95% tohto kodu je z internetu-->
<canvas id="@_canvasId"
        style="width: 300px; height: 150px"
        @attributes="AdditionalAttributes">
</canvas>

@code {

    private string _canvasId = "sharpEngineCanvas";
    private IJSObjectReference? _jsModule;

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    public CanvasInterop CanvasInterop { get; } = new CanvasInterop();
    public Scene Scene { get; } = new Scene();

    private SceneView? _sceneView;
    public SceneView SceneView
    {
        get
        {
            _sceneView ??= new SceneView(Scene);
            return _sceneView;
        }
    }

    public WebGLDevice? GpuDevice { get; private set; }
    public bool IsInitialized => GpuDevice != null;

    public event EventHandler? SceneViewInitialized;

    protected override void OnInitialized()
    {
        _canvasId = CanvasInterop.CanvasId;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        if (!OperatingSystem.IsBrowser())
            return;

        _jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/CanvasTools.js");

        await CanvasInterop.InitializeInterop();
        
        // Zachovanei frame buffera pre thumbnail!!!!
        await _jsModule.InvokeAsync<bool>("ensurePreserveDrawingBufferForCanvas", _canvasId);

        CanvasInterop.InitWebGL(useMultisampleAntiAliasing: false);

        if (!CanvasInterop.IsWebGLInitialized)
            return;

        GpuDevice = WebGLDevice.Create(CanvasInterop);
        if (!GpuDevice.IsInitialized)
            return;

        SceneView.Initialize(GpuDevice);
        SceneViewInitialized?.Invoke(this, EventArgs.Empty);
    }
    public void Dispose()
    {
        if (_sceneView != null && !_sceneView.IsDisposed)
            _sceneView.Dispose();

        if (!Scene.IsDisposed)
            Scene.Dispose();

        if (GpuDevice != null)
        {
            GpuDevice.Dispose();
            GpuDevice = null;
        }

        if (CanvasInterop.IsWebGLInitialized)
            CanvasInterop.Dispose();
    }

    public async ValueTask DisposeAsync()
    {
        if (OperatingSystem.IsBrowser() && _jsModule is not null)
        {
            try
            {
                await _jsModule.DisposeAsync();
            }
            catch
            {
                // ignore teardown failures
            }
        }

        Dispose();
    }
}
